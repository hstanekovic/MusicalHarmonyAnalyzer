<html>

<head>
    <title>Musical Harmony Analyzer</title>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
.clickable:hover {
    cursor: pointer;
}

.heading {
    font-size: 1.1em;
    color:dimgray;
}

.topMargin {
    margin-top: 10px;
}

.bottomMargin {
    margin-bottom: 10px;
}

.leftMargin {
    margin-left: 10px;
}

.rightPadding {
    padding-right: 10px;
}

.notDisplayed {
    display:none
}

.noSelect {
    -webkit-user-select: none;
    -khtml-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
}

@media (orientation: portrait) {
    div.piano {
     width: 77vw;
     height: 33vw;
    }
}

@media (orientation: landscape) {
    div.piano {
     width: 77vh;
     height: 33vh;
    }
}

div.pianoKeys {
    height: calc(100% - 30px);
    position: relative;
}

div.pianoKeyLabels {
    height: 30px;
    position: relative;
}

div.pianoKey {
    position: absolute;
    top: 0%;
    border-width: 2px;
    border-style: solid;
    border-radius: 8px;
}

div.pianoKeyLabel {
    position: absolute;
    top: 10px;
    text-align: center;
}

div.whiteKey {
    width: 14%;
    height: 100%;
    z-index: 0;
    background-color: white;
}

div.blackKey {
    width: 8%;
    height: 60%;
    z-index: 10;
    background-color: black;
}

div.whiteKeyLabel {
    width: 14%;
}

div.blackKeyLabel {
    width: 8%;
}

div.c {
    left: 0;
}

div.cSharp {
    left: 10%;
}

div.d {
    left: 14%;
}

div.dSharp {
    left: 24%;
}

div.e {
    left: 28%;
}

div.f {
    left: 42%;
}

div.FSharp {
    left: 52%;
}

div.g {
    left: 56%;
}

div.gSharp {
    left: 66%;
}

div.a {
    left: 70%;
}

div.aSharp {
    left: 80%;
}

div.b {
    left: 84%;
}

span.tabSelected {
    background-color: white;
    border-style: solid;
    border-bottom-style: none;
    border-top-left-radius: 5px;
    border-top-right-radius: 5px;
    padding-left: 0.4em;
    padding-right: 0.4em;
    padding-top: 0.3em;
    padding-bottom: 0.3em;
    font-size: 0.9em;
    line-height: 2em;
}

span.tabNotSelected {
    background-color: silver;
    border-top-left-radius: 5px;
    border-top-right-radius: 5px;
    padding-left: 0.4em;
    padding-right: 0.4em;
    padding-top: 0.3em;
    padding-bottom: 0.3em;
    font-size: 0.8em;
    line-height: 2em;
}

div.annotation {
    font-size: 1.6em;
}

div.annotation span.block {
    display: inline-block;
}

div.annotation span.block span.leftSuperscript {
    position: relative; 
    display: block; 
    font-size: .6em; 
    top: -0.8em;
}

div.annotation span.block span.middleSuperscript {
    position: relative; 
    display: block; 
    font-size: .6em; 
    line-height: 0.8;
}

div.annotation span.block span.middleSubscript {
    position: relative; 
    display: block; 
    font-size: .6em; 
    line-height: 0.8;
    top: .2em;
}

input.collapsibleSwitch:not(:checked) + br + div.collapsible {
    display: none;
}

.annotation.leftmargin {
    margin-left: 1em;
}

div.smallWindow {
    position: fixed;
    width: 30vw;
    background-color: silver;
    padding-left: 2em;
    padding-right: 2em;
    padding-top: 2em;
    padding-bottom: 2em;
    display: none;
    z-index: 100;
}

input.imageButton {
    width: 1.5em;
    height: 1.5em;
    padding: 0.5em;
    border-style: solid;
    border-color: black;
    border-radius: 0.3em;
}

.control {
    background-color: silver;
}

table.harmonyView {
    position: absolute;
    right: 0.5em;
    top: 0.5em;
    border-spacing: 0;
    border-collapse: collapse;
    font-size: 0.8em;
}

@media (orientation: portrait) {
    table.harmonyView td {
        width: 10vw;
        height: 4vw;
        border-style: solid; 
        border-color: black;
        padding-left: 1em;
    }
}

@media (orientation: landscape) {
    table.harmonyView td {
        width: 10vh;
        height: 4vh;
        border-style: solid; 
        border-color: black;
        padding-left: 1em;
    }
}
    </style>
    <script>
class MusicalNote {

    static get noteNameLetters() { return ["C", "D", "E", "F", "G", "A", "B"]; }

    static get noteNameOffsets() { return [0, 2, 4, 5, 7, 9, 11]; }

    static get accidentals() { return ["bbb", "bb", "b", "", "#", "x", "#x"]; }

    static get accidentalOffsets() { return [-3, -2, -1, 0, 1, 2, 3]; }

    static FromMusicalNote(musicalNote) {
        return new MusicalNote(musicalNote.Name, musicalNote.Octave);
    }

    static FromStaffPositionAndPitch(staffPosition, pitch) {
        let octave = Math.floor(staffPosition / 7) + 4;
        let nameIndex = staffPosition % 7;
        if (nameIndex < 0) nameIndex += 7;
        let name = MusicalNote.noteNameLetters[nameIndex];
        let musicalNote = new MusicalNote(name, octave);
        let pitchWithoutAccidental = musicalNote.determinePitch();
        musicalNote.Name += MusicalNote.accidentals[MusicalNote.accidentalOffsets.findIndex(i => i == (pitch - pitchWithoutAccidental))];
        return musicalNote;
    }

    constructor(name, octave) {
        this.Name = name;
        this.Octave = octave;
    }

    get NamePrettified() { return new NoteName(this.Name).NamePrettified; }

    get StaffPosition() { return this.determineStaffPosition(); }

    get Pitch() { return this.determinePitch(); }

    AddInterval(musicalInterval) {
        let newStaffPosition = this.StaffPosition + musicalInterval.Number - 1;
        let newPitch = this.Pitch + musicalInterval.PitchCount;
        return MusicalNote.FromStaffPositionAndPitch(newStaffPosition, newPitch);
    }

    IsEqual(comparedWith) {
        if (comparedWith == null) return false;
        return (this.Name == comparedWith.Name) && (this.Octave == comparedWith.Octave);
    }

    ToString() {
        return this.Name + this.Octave;
    }

    determineStaffPosition() {
        let noteNameLetter = this.Name.substring(0, 1);
        let staffPosition = MusicalNote.noteNameLetters.findIndex(i => i == noteNameLetter) + (this.Octave - 4) * 7;
        return staffPosition;
    }

    determinePitch() {
        let noteNameLetter = this.Name.substring(0, 1);
        let accidental = this.Name.length > 1 ? this.Name.substring(1) : "";
        let pitch = MusicalNote.noteNameOffsets[MusicalNote.noteNameLetters.findIndex(i => i == noteNameLetter)] +
            MusicalNote.accidentalOffsets[MusicalNote.accidentals.findIndex(i => i == accidental)] + (this.Octave - 4) * 12;
        return pitch;
    }
}

class NoteName {

    constructor(name) {
        this.musicalNote = new MusicalNote(name, 4);
    }

    get Name() { return this.musicalNote.Name; }

    get NamePrettified() { return this.prettify(); }

    get PitchClass() { return this.determinePitchClass(); }

    AddInterval(musicalInterval) {
        let newMusicalNote = this.musicalNote.AddInterval(musicalInterval);
        return new NoteName(newMusicalNote.Name);
    }

    IsEqual(comparedWith) {
        if (comparedWith == null) return false;
        return this.Name == comparedWith.Name;
    }

    ToString() {
        return this.Name;
    }

    prettify() {
        return this.Name.replace("b", "♭").replace("b", "♭").replace("#", "♯");
    }

    determinePitchClass() {
        var pitchClass = this.musicalNote.Pitch % 12;
        if (pitchClass < 0) pitchClass += 12;
        return pitchClass;
    }
}

class MusicalInterval {

    static get Qualities() { return { Diminished: 0, Minor: 1, Perfect: 2, Major: 3, Augmented: 4 } };
    static get PerfectPrime() { return new MusicalInterval(1, this.Qualities.Perfect) };
    static get AugmentedPrime() { return new MusicalInterval(1, this.Qualities.Augmented) };
    static get DiminishedSecond() { return new MusicalInterval(2, Qualities.Diminished) };
    static get MinorSecond() { return new MusicalInterval(2, this.Qualities.Minor) };
    static get MajorSecond() { return new MusicalInterval(2, this.Qualities.Major) };
    static get AugmentedSecond() { return new MusicalInterval(2, this.Qualities.Augmented) };
    static get DiminishedThird() { return new MusicalInterval(3, this.Qualities.Diminished) };
    static get MinorThird() { return new MusicalInterval(3, this.Qualities.Minor) };
    static get MajorThird() { return new MusicalInterval(3, this.Qualities.Major) };
    static get AugmentedThird() { return new MusicalInterval(3, this.Qualities.Augmented) };
    static get DiminishedFourth() { return new MusicalInterval(4, this.Qualities.Diminished) };
    static get PerfectFourth() { return new MusicalInterval(4, this.Qualities.Perfect) };
    static get AugmentedFourth() { return new MusicalInterval(4, this.Qualities.Augmented) };
    static get DiminishedFifth() { return new MusicalInterval(5, this.Qualities.Diminished) };
    static get PerfectFifth() { return new MusicalInterval(5, this.Qualities.Perfect) };
    static get AugmentedFifth() { return new MusicalInterval(5, this.Qualities.Augmented) };
    static get DiminishedSixth() { return new MusicalInterval(6, this.Qualities.Diminished) };
    static get MinorSixth() { return new MusicalInterval(6, this.Qualities.Minor) };
    static get MajorSixth() { return new MusicalInterval(6, this.Qualities.Major) };
    static get AugmentedSixth() { return new MusicalInterval(6, this.Qualities.Augmented) };
    static get DiminishedSeventh() { return new MusicalInterval(7, this.Qualities.Diminished) };
    static get MinorSeventh() { return new MusicalInterval(7, this.Qualities.Minor) };
    static get MajorSeventh() { return new MusicalInterval(7, this.Qualities.Major) };
    static get AugmentedSeventh() { return new MusicalInterval(7, this.Qualities.Augmented) };
    static get DiminishedOctave() { return new MusicalInterval(8, this.Qualities.Diminished) };
    static get PerfectOctave() { return new MusicalInterval(8, this.Qualities.Perfect) };
    static get AugmentedOctave() { return new MusicalInterval(8, this.Qualities.Augmented) };

    constructor(number, quality) {
        this.Number = number;
        this.Quality = quality;
        this.annotations = ["d", "m", "P", "M", "A"];
        this.perfectIntervals = [1, 4, 5];
        this.numberPitchCounts = [0, 2, 4, 5, 7, 9, 11];
        this.qualityOffsetsPerfect = [-1, null, 0, null, 1];
        this.qualityOffsetsNonPerfect = [-2, -1, null, 0, 1];
    }

    get PitchCount() { return this.determinePitchCount(); }

    IsEqual(comparedWith) {
        if (comparedWith == null) return false;
        return (this.Number == comparedWith.Number) && (this.Quality == comparedWith.Quality);
    }

    ToString() {
        return this.annotations[this.Quality] + this.Number;
    }

    determinePitchCount() {
        let isDescending = this.Number < 0;
        let number = Math.abs(this.Number);
        let simpleInterval = (this.Number - 1) % 7;
        let octaves = Math.trunc((this.Number - 1) / 7);
        let pitchCount = this.numberPitchCounts[simpleInterval] + octaves * 12;
        if (this.perfectIntervals.includes(number)) pitchCount += this.qualityOffsetsPerfect[this.Quality];
        else pitchCount += this.qualityOffsetsNonPerfect[this.Quality];
        if (isDescending) return -pitchCount;
        return pitchCount;
    }
}

class MusicalAnnotation {

    constructor(leftBaseline, leftSuperscript, middleSuperscript, middleSubscript, rightBaseline) {
        this.LeftBaseline = leftBaseline;
        this.LeftSuperscript = leftSuperscript;
        this.MiddleSuperscript = middleSuperscript;
        this.MiddleSubscript = middleSubscript;
        this.RightBaseline = rightBaseline;
    }

    Render() {
        let html = this.LeftBaseline;
        html += "<span class='block'><span class='leftSuperscript'>" + this.LeftSuperscript + "</span></span>";
        html += "<span class='block'><span class='middleSuperscript'>" + this.MiddleSuperscript + "</span>";
        html += "<span class='middleSubscript'>" + (this.MiddleSubscript == "" ? "&nbsp;" : this.MiddleSubscript) + "</span></span>";
        html += this.RightBaseline;
        return html;
    }

    ToString() {
        return (this.LeftBaseline + this.LeftSuperscript + this.MiddleSuperscript + this.MiddleSubscript + this.RightBaseline).replace("♭", "b").replace("♯", "#");
    }
}

class MusicalKeyOrChord {

    static FromTonicOrRootAndType(tonicOrRoot, type) {
        let generatedMusicalKeysOrChords = RelatedMusicalKeysOrChords.Get(type);
        generatedMusicalKeysOrChords = generatedMusicalKeysOrChords.filter(mkoc => mkoc.TonicOrRoot.IsEqual(tonicOrRoot));
        if (generatedMusicalKeysOrChords.length == 0) return null;
        let generatedMusicalKeyOrChord = generatedMusicalKeysOrChords[0];
        return new MusicalKeyOrChord(tonicOrRoot, type, generatedMusicalKeyOrChord.Name, generatedMusicalKeyOrChord.Annotation, generatedMusicalKeyOrChord.NoteNames);
    }

    static get Types() {
        return {
            MajorKey: 0, MinorKey: 1, MinorKeyUnaltered: 2, MinorKeyRaised7th: 3, MinorKeyRaised6th7th: 4, 
            MajorTriadChord: 5, MinorTriadChord: 6, DiminishedTriadChord: 7, AugmentedTriadChord: 8,
            DominantSeventhChord: 9, MajorSeventhChord: 10, MinorSeventhChord: 11, DiminishedSeventhChord: 12, HalfDiminishedSeventhChord: 13,
            AugmentedSeventhChord: 14, MinorMajorSeventhChord: 15, AugmentedMajorSeventhChord: 16,
            DominantNinthChord: 17, DominantMinorNinthChord: 18, MajorNinthChord: 19, MinorNinthChord: 20,
            DiminishedTriadChordLowered3rd: 21, DiminishedSeventhChordLowered3rd: 22, DominantSeventhChordLowered5th: 23
        }
    }

    constructor(tonicOrRoot, type, name, annotation, noteNames) {
        this.TonicOrRoot = tonicOrRoot;
        this.Type = type;
        this.Name = name;
        this.Annotation = annotation;
        this.NoteNames = noteNames;
    }

    HasAllNoteNamesCommonWith(comparedWith) {
        return this.NoteNames.every(nn => comparedWith.NoteNames.some(nn2 => nn2.IsEqual(nn)));
    }

    HasInversions() {
        if (this.NoteNames.length != 3 && this.NoteNames.length != 4) return false;
        return true;
    }

    GetInversion(bassNote) {
        let positions = ["root position", "1st inversion", "2nd inversion", "3rd inversion"];
        let inversion = bassNote != null ? this.NoteNames.findIndex(nn => nn.IsEqual(bassNote)) : 0;
        if (inversion < 0) return this;
        let noteNames = this.NoteNames.slice(inversion).concat(this.NoteNames.slice(0, inversion));
        let musicalKeyOrChord = new MusicalKeyOrChord(
            this.TonicOrRoot,
            this.Type,
            this.Name + " in " + positions[inversion],
            new MusicalAnnotation(this.Annotation.LeftBaseline, this.Annotation.LeftSuperscript, this.Annotation.MiddleSuperscript, this.Annotation.MiddleSubscript,
                inversion == 0 ? "" : "/" + bassNote.NamePrettified),
            noteNames);
        musicalKeyOrChord.Inversion = inversion;
        musicalKeyOrChord.NoteNamesInRootPosition = this.NoteNames;
        return musicalKeyOrChord;
    }

    IsEqual(comparedWith) {
        if (comparedWith == null) return false;
        return this.TonicOrRoot.IsEqual(comparedWith.TonicOrRoot) && this.Type == comparedWith.Type;
    }

    ToString() {
        return this.Annotation.ToString();
    }
}

class RelatedMusicalKeysOrChordsConfiguration {
    constructor(tonicsOrRoots, musicalIntervals, annotationLeftBaselineLowerCase, annotationLeftSuperscript, annotationMiddleSuperscript, annotationMiddleSubscript, nameSuffix) {
        this.TonicsOrRoots = tonicsOrRoots;
        this.MusicalIntervals = musicalIntervals;
        this.AnnotationLeftBaselineLowerCase = annotationLeftBaselineLowerCase;
        this.AnnotationLeftSuperscript = annotationLeftSuperscript;
        this.AnnotationMiddleSuperscript = annotationMiddleSuperscript;
        this.AnnotationMiddleSubscript = annotationMiddleSubscript;
        this.NameSuffix = nameSuffix;
    }
}

class RelatedMusicalKeysOrChords extends Array {

    static Get(type) {
        if (RelatedMusicalKeysOrChords.cache == undefined) RelatedMusicalKeysOrChords.generate();
        return RelatedMusicalKeysOrChords.cache.get(type);
    };

    static get majorKeyTonics() { return [new NoteName("Cb"), new NoteName("Gb"), new NoteName("Db"), new NoteName("Ab"), new NoteName("Eb"), new NoteName("Bb"), new NoteName("F"), new NoteName("C"), new NoteName("G"), new NoteName("D"), new NoteName("A"), new NoteName("E"), new NoteName("B"), new NoteName("F#"), new NoteName("C#")] };
    static get minorKeyTonics() { return [new NoteName("Ab"), new NoteName("Eb"), new NoteName("Bb"), new NoteName("F"), new NoteName("C"), new NoteName("G"), new NoteName("D"), new NoteName("A"), new NoteName("E"), new NoteName("B"), new NoteName("F#"), new NoteName("C#"), new NoteName("G#"), new NoteName("D#"), new NoteName("A#")] };
    static get chordRoots() { return [new NoteName("Cbb"), new NoteName("Cb"), new NoteName("C"), new NoteName("C#"), new NoteName("Cx"), 
                                      new NoteName("Dbb"), new NoteName("Db"), new NoteName("D"), new NoteName("D#"), new NoteName("Dx"),
                                      new NoteName("Ebb"), new NoteName("Eb"), new NoteName("E"), new NoteName("E#"), new NoteName("Ex"), 
                                      new NoteName("Fbb"), new NoteName("Fb"), new NoteName("F"), new NoteName("F#"), new NoteName("Fx"),
                                      new NoteName("Gbb"), new NoteName("Gb"), new NoteName("G"), new NoteName("G#"), new NoteName("Gx"), 
                                      new NoteName("Abb"), new NoteName("Ab"), new NoteName("A"), new NoteName("A#"), new NoteName("Ax"), 
                                      new NoteName("Bbb"), new NoteName("Bb"), new NoteName("B"), new NoteName("B#"), new NoteName("Bx")] };
    static get configurations() {
        return new Map([
            [MusicalKeyOrChord.Types.MajorKey, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.majorKeyTonics, [MusicalInterval.MajorSecond, MusicalInterval.MajorSecond, MusicalInterval.MinorSecond, MusicalInterval.MajorSecond, MusicalInterval.MajorSecond, MusicalInterval.MajorSecond], false, "", "", "", "major key")],
            [MusicalKeyOrChord.Types.MinorKey, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.minorKeyTonics, [MusicalInterval.MajorSecond, MusicalInterval.MinorSecond, MusicalInterval.MajorSecond, MusicalInterval.MajorSecond, MusicalInterval.MinorSecond, MusicalInterval.AugmentedPrime, MusicalInterval.MinorSecond, MusicalInterval.AugmentedPrime], true, "", "", "", "minor key")],
            [MusicalKeyOrChord.Types.MinorKeyUnaltered, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.minorKeyTonics, [MusicalInterval.MajorSecond, MusicalInterval.MinorSecond, MusicalInterval.MajorSecond, MusicalInterval.MajorSecond, MusicalInterval.MinorSecond, MusicalInterval.MajorSecond], true, "", "", "", "minor key without alterations")],
            [MusicalKeyOrChord.Types.MinorKeyRaised7th, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.minorKeyTonics, [MusicalInterval.MajorSecond, MusicalInterval.MinorSecond, MusicalInterval.MajorSecond, MusicalInterval.MajorSecond, MusicalInterval.MinorSecond, MusicalInterval.AugmentedSecond], true, "", "", "", "minor key with raised 7th scale degree")],
            [MusicalKeyOrChord.Types.MinorKeyRaised6th7th, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.minorKeyTonics, [MusicalInterval.MajorSecond, MusicalInterval.MinorSecond, MusicalInterval.MajorSecond, MusicalInterval.MajorSecond, MusicalInterval.MajorSecond, MusicalInterval.MajorSecond], true, "", "", "", "minor key with raised 6th and 7th scale degrees")],
            [MusicalKeyOrChord.Types.MajorTriadChord, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.MajorThird, MusicalInterval.MinorThird], false, "", "", "", "major triad chord")],
            [MusicalKeyOrChord.Types.MinorTriadChord, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.MinorThird, MusicalInterval.MajorThird], false, "m", "", "", "minor triad chord")],
            [MusicalKeyOrChord.Types.DiminishedTriadChord, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.MinorThird, MusicalInterval.MinorThird], false, "o", "", "", "diminished triad chord")],
            [MusicalKeyOrChord.Types.AugmentedTriadChord, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.MajorThird, MusicalInterval.MajorThird], false, "+", "", "", "augmented triad chord")],
            [MusicalKeyOrChord.Types.DominantSeventhChord, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.MajorThird, MusicalInterval.MinorThird, MusicalInterval.MinorThird], false, "", "7", "", "dominant seventh chord")],
            [MusicalKeyOrChord.Types.MajorSeventhChord, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.MajorThird, MusicalInterval.MinorThird, MusicalInterval.MajorThird], false, "Δ", "7", "", "major seventh chord")],
            [MusicalKeyOrChord.Types.MinorSeventhChord, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.MinorThird, MusicalInterval.MajorThird, MusicalInterval.MinorThird], false, "m", "7", "", "minor seventh chord")],
            [MusicalKeyOrChord.Types.DiminishedSeventhChord, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.MinorThird, MusicalInterval.MinorThird, MusicalInterval.MinorThird], false, "o", "7", "", "diminished seventh chord")],
            [MusicalKeyOrChord.Types.HalfDiminishedSeventhChord, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.MinorThird, MusicalInterval.MinorThird, MusicalInterval.MajorThird], false, "ø", "7", "", "half-diminished seventh chord")],
            [MusicalKeyOrChord.Types.AugmentedSeventhChord, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.MajorThird, MusicalInterval.MajorThird, MusicalInterval.DiminishedThird], false, "+", "7", "", "augmented seventh chord")],
            [MusicalKeyOrChord.Types.MinorMajorSeventhChord, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.MinorThird, MusicalInterval.MajorThird, MusicalInterval.MajorThird], false, "mΔ", "7", "", "minor-major seventh chord")],
            [MusicalKeyOrChord.Types.AugmentedMajorSeventhChord, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.MajorThird, MusicalInterval.MajorThird, MusicalInterval.MinorThird], false, "+Δ", "7", "", "augmented-major seventh chord")],
            [MusicalKeyOrChord.Types.DominantNinthChord, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.MajorThird, MusicalInterval.MinorThird, MusicalInterval.MinorThird, MusicalInterval.MajorThird], false, "", "9", "", "dominant ninth chord")],
            [MusicalKeyOrChord.Types.DominantMinorNinthChord, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.MajorThird, MusicalInterval.MinorThird, MusicalInterval.MinorThird, MusicalInterval.MinorThird], false, "", "♭9", "", "dominant minor ninth chord")],
            [MusicalKeyOrChord.Types.MajorNinthChord, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.MajorThird, MusicalInterval.MinorThird, MusicalInterval.MajorThird, MusicalInterval.MinorThird], false, "Δ", "9", "", "major ninth chord")],
            [MusicalKeyOrChord.Types.MinorNinthChord, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.MinorThird, MusicalInterval.MajorThird, MusicalInterval.MinorThird, MusicalInterval.MajorThird], false, "m", "9", "", "minor ninth chord")],
            [MusicalKeyOrChord.Types.DiminishedTriadChordLowered3rd, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.DiminishedThird, MusicalInterval.MajorThird], false, "o", "(♭3)", "", "diminished triad flat three chord (not correct, for the details please see the book!)")],
            [MusicalKeyOrChord.Types.DiminishedSeventhChordLowered3rd, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.DiminishedThird, MusicalInterval.MajorThird, MusicalInterval.MinorThird], false, "o", "7(♭3)", "", "diminished seventh flat three chord (not correct, for the details please see the book!)")],
            [MusicalKeyOrChord.Types.DominantSeventhChordLowered5th, new RelatedMusicalKeysOrChordsConfiguration(RelatedMusicalKeysOrChords.chordRoots, [MusicalInterval.MajorThird, MusicalInterval.DiminishedThird, MusicalInterval.MajorThird], false, "7", "(♭5)", "", "dominant seventh flat five chord")]]);
    };

    static generate() {
        RelatedMusicalKeysOrChords.cache = new Map();
        for (let typeName in MusicalKeyOrChord.Types) {
            let type = MusicalKeyOrChord.Types[typeName];
            let configuration = RelatedMusicalKeysOrChords.configurations.get(type);
            let relatedMusicalKeysOrChords = new RelatedMusicalKeysOrChords();
            for (let tonicOrRoot of configuration.TonicsOrRoots) {
                let name = tonicOrRoot.NamePrettified + " " + configuration.NameSuffix;
                let annotationLeftBaseline = configuration.AnnotationLeftBaselineLowerCase ? tonicOrRoot.NamePrettified.toLowerCase() : tonicOrRoot.NamePrettified;
                let noteNames = [];
                let noteName = tonicOrRoot;
                noteNames.push(noteName);
                let hasTripleAccidental = false;
                for (let musicalInterval of configuration.MusicalIntervals) {
                    noteName = noteName.AddInterval(musicalInterval);
                    if (noteName.Name.includes("bbb") || noteName.Name.includes("#x")) hasTripleAccidental = true;
                    noteNames.push(noteName);
                }
                if (!hasTripleAccidental)
                    relatedMusicalKeysOrChords.push(new MusicalKeyOrChord(tonicOrRoot, type, name,
                        new MusicalAnnotation(annotationLeftBaseline, configuration.AnnotationLeftSuperscript, configuration.AnnotationMiddleSuperscript, configuration.AnnotationMiddleSubscript, ""), noteNames));
            }
            RelatedMusicalKeysOrChords.cache.set(type, relatedMusicalKeysOrChords);
        }
    }

    constructor(...musicalKeysOrChords) {
        super(...musicalKeysOrChords);
    }

    Search(noteNames, fullMatchOnly, enharmonicEquivalence, bassNote) {
        if (noteNames.length == 0) return [];
        let musicalKeysOrChords = this;
        for (let searchedNoteName of noteNames) 
            if (!enharmonicEquivalence) musicalKeysOrChords = musicalKeysOrChords.filter(mkoc => mkoc.NoteNames.some(nn => nn.Name == searchedNoteName.Name));
            else musicalKeysOrChords = musicalKeysOrChords.filter(mkoc => mkoc.NoteNames.some(nn => nn.PitchClass == searchedNoteName.PitchClass));
        if (fullMatchOnly) musicalKeysOrChords = musicalKeysOrChords.filter(mkoc => mkoc.NoteNames.length == noteNames.length);
        if (this[0].HasInversions() && bassNote != undefined) musicalKeysOrChords = musicalKeysOrChords.map(mkoc => mkoc.GetInversion(bassNote));
        return musicalKeysOrChords;
    }

    ToString() {
        let string = "";
        let index = 0;
        for (let musicalKeyOrChord of this) {
            if (index++ == 0) string += musicalKeyOrChord.ToString();
            else string += ", " + musicalKeyOrChord.ToString();
        }
        return string;
    }
}

class MusicalHarmony {

    static get Types() {
        return {
            DiatonicTriadChord: 0, DiatonicSeventhChord: 1, DiatonicNinthChord: 2,
            BorrowedTriadChord: 3, BorrowedSeventhChord: 4, BorrowedNinthChord: 5,
            NeapolitanChord: 6, ItalianSixthChord: 7, GermanSixthChord: 8, FrenchSixthChord: 9,
            SecondaryDiatonicTriadChord: 10, SecondaryDiatonicSeventhChord: 11, SecondaryDiatonicNinthChord: 12,
            SecondaryNeapolitanChord: 13, SecondaryItalianSixthChord: 14, SecondaryGermanSixthChord: 15, SecondaryFrenchSixthChord: 16
        }
    }

    constructor(type, name, annotation, musicalKey, musicalChord) {
        this.Type = type;
        this.Name = name;
        this.Annotation = annotation;
        this.MusicalKey = musicalKey;
        this.MusicalChord = musicalChord;
    }

    GetInversion(bassNote) {
        let positions = ["root position", "1st inversion", "2nd inversion", "3rd inversion"];
        let annotationMiddleSuperscriptsTriadChords = ["", "6", "6"];
        let annotationMiddleSubscriptsTriadChords = ["", "", "4"];
        let annotationMiddleSuperscriptsSeventhChords = ["7", "6", "4", "4"];
        let annotationMiddleSubscriptsSeventhChords = ["", "5", "3", "2"];
        let inversion = bassNote != null ? this.MusicalChord.NoteNames.findIndex(nn => nn.IsEqual(bassNote)) : 0;
        if (inversion < 0) return this;
        let name, annotationMiddleSuperscript, annotationMiddleSubscript;
        if (this.Type == MusicalHarmony.Types.ItalianSixthChord || this.Type == MusicalHarmony.Types.GermanSixthChord || this.Type == MusicalHarmony.Types.FrenchSixthChord ||
            this.Type == MusicalHarmony.Types.SecondaryItalianSixthChord || this.Type == MusicalHarmony.Types.SecondaryGermanSixthChord || this.Type == MusicalHarmony.Types.SecondaryFrenchSixthChord) {
            name = this.Name;
            annotationMiddleSuperscript = this.Annotation.MiddleSuperscript;
            annotationMiddleSubscript = this.Annotation.MiddleSubscript;
        }
        else {
            name = this.Name + " in " + positions[inversion];
            if (this.MusicalChord.NoteNames.length == 3) {
                annotationMiddleSuperscript = annotationMiddleSuperscriptsTriadChords[inversion];
                annotationMiddleSubscript = annotationMiddleSubscriptsTriadChords[inversion];
            }
            else {
                annotationMiddleSuperscript = annotationMiddleSuperscriptsSeventhChords[inversion];
                annotationMiddleSubscript = annotationMiddleSubscriptsSeventhChords[inversion];
            }
        }
        return new MusicalHarmony(
            this.Type,
            name,
            new MusicalAnnotation(this.Annotation.LeftBaseline, this.Annotation.LeftSuperscript, annotationMiddleSuperscript, annotationMiddleSubscript, this.Annotation.RightBaseline),
            this.MusicalKey,
            this.MusicalChord.GetInversion(bassNote));
    }

    IsEqual(comparedWith) {
        if (comparedWith == null) return false;
        return this.MusicalKey.IsEqual(comparedWith.MusicalKey) && this.MusicalChord.IsEqual(comparedWith.MusicalChord);
    }

    ToString() {
        return this.Annotation.ToString();
    }
}
 
class RelatedMusicalHarmonies extends Array {

    static Get(type) {
        if (RelatedMusicalHarmonies.cache == undefined) { RelatedMusicalHarmonies.generate(); }
        return RelatedMusicalHarmonies.cache.get(type);
    };

    static get romanNumerals() { return ["I", "II", "III", "IV", "V", "VI", "VII"]; }
    static get ordinalNumbers() { return ["1st", "2nd", "3rd", "4th", "5th", "6th", "7th"]; }
    static get allMusicalKeys() { return [...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.MajorKey), ...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.MinorKey)]; }
    static get allTriadChords() {
        return [
            ...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.MajorTriadChord),
            ...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.MinorTriadChord),
            ...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.DiminishedTriadChord),
            ...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.AugmentedTriadChord)
        ];
    }
    static get allSeventhChords() {
        return [
            ...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.DominantSeventhChord),
            ...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.MajorSeventhChord),
            ...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.MinorSeventhChord),
            ...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.DiminishedSeventhChord),
            ...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.HalfDiminishedSeventhChord),
            ...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.AugmentedSeventhChord),
            ...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.MinorMajorSeventhChord),
            ...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.AugmentedMajorSeventhChord)
        ];
    }
    static get allNinthChords() {
        return [
            ...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.DominantNinthChord),
            ...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.DominantMinorNinthChord),
            ...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.MajorNinthChord),
            ...RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.MinorNinthChord)
        ];
    }
    static get secondaryChordsMappings() {
        return new Map([
            [MusicalHarmony.Types.DiatonicTriadChord, MusicalHarmony.Types.SecondaryDiatonicTriadChord],
            [MusicalHarmony.Types.DiatonicSeventhChord, MusicalHarmony.Types.SecondaryDiatonicSeventhChord],
            [MusicalHarmony.Types.DiatonicNinthChord, MusicalHarmony.Types.SecondaryDiatonicNinthChord],
            [MusicalHarmony.Types.NeapolitanChord, MusicalHarmony.Types.SecondaryNeapolitanChord],
            [MusicalHarmony.Types.ItalianSixthChord, MusicalHarmony.Types.SecondaryItalianSixthChord],
            [MusicalHarmony.Types.GermanSixthChord, MusicalHarmony.Types.SecondaryGermanSixthChord],
            [MusicalHarmony.Types.FrenchSixthChord, MusicalHarmony.Types.SecondaryFrenchSixthChord]
        ]);
    };

   static generateDiatonicChords(type, musicalChords) {
        let diatonicChords = new RelatedMusicalHarmonies();
        for (let musicalKey of RelatedMusicalHarmonies.allMusicalKeys) 
            for (let musicalChord of musicalChords)
                if (musicalChord.HasAllNoteNamesCommonWith(musicalKey)) {
                    let chordRoot = musicalChord.TonicOrRoot;
                    let scaleDegree = musicalKey.NoteNames.findIndex(nn => nn.IsEqual(chordRoot)) + 1;
                    let isScaleDegreeRaised = false;
                    if (musicalKey.Type == MusicalKeyOrChord.Types.MinorKey) {
                        if (scaleDegree == 7) { scaleDegree = 6; isScaleDegreeRaised = true; }
                        if (scaleDegree == 8 ) { scaleDegree = 7; }
                        if (scaleDegree == 9 ) { scaleDegree = 7; isScaleDegreeRaised = true; }
                    }
                    let romanNumeral = RelatedMusicalHarmonies.romanNumerals[scaleDegree - 1];
                    if (scaleDegree == 6 && isScaleDegreeRaised) romanNumeral = "♯" + romanNumeral;
                    if (chordRoot.AddInterval(MusicalInterval.MinorThird).IsEqual(musicalChord.NoteNames[1])) romanNumeral = romanNumeral.toLowerCase();
                    let annotation = new MusicalAnnotation(
                        musicalKey.Annotation.LeftBaseline + ": " + romanNumeral, musicalChord.Annotation.LeftSuperscript.replace("m", ""),
                        musicalChord.Annotation.MiddleSuperscript, musicalChord.Annotation.MiddleSubscript, "");
                    let chordType = musicalChord.Name.substring(musicalChord.Name.indexOf(' ') + 1);
                    let ordinalNumber = (isScaleDegreeRaised ? "raised " : "") + RelatedMusicalHarmonies.ordinalNumbers[scaleDegree - 1];
                    let name = musicalKey.Name + ": " + chordType + " on " + ordinalNumber + " scale degree";
                    let diatonicChord = new MusicalHarmony(type, name, annotation, musicalKey, musicalChord);
                    diatonicChords.push(diatonicChord);
                }
        return diatonicChords;
    }

    static generateBorrowedChords(type, musicalChords, nameInfix2) {
        let borrowedChords = new RelatedMusicalHarmonies();
        for (let musicalKey of RelatedMusicalHarmonies.allMusicalKeys) {
            let parallelMusicalKey;
            if (musicalKey.Type == MusicalKeyOrChord.Types.MinorKey) 
                parallelMusicalKey = MusicalKeyOrChord.FromTonicOrRootAndType(musicalKey.TonicOrRoot, MusicalKeyOrChord.Types.MajorKey);
            if (musicalKey.Type == MusicalKeyOrChord.Types.MajorKey) 
                parallelMusicalKey = MusicalKeyOrChord.FromTonicOrRootAndType(musicalKey.TonicOrRoot, MusicalKeyOrChord.Types.MinorKey);
            if (parallelMusicalKey == null) continue;
            for (let musicalChord of musicalChords) {
                if (musicalChord.HasAllNoteNamesCommonWith(musicalKey)) { continue; }
                if (musicalChord.HasAllNoteNamesCommonWith(parallelMusicalKey)) {
                    let chordRoot = musicalChord.TonicOrRoot;
                    let scaleDegreeUnaltered = parallelMusicalKey.NoteNames.findIndex(nn => nn.IsEqual(chordRoot)) + 1;
                    let scaleDegreeAlteration = "";
                    if (parallelMusicalKey.Type == MusicalKeyOrChord.Types.MinorKey)
                        if (scaleDegreeUnaltered == 3) scaleDegreeAlteration = "♭";
                        else if (scaleDegreeUnaltered == 6) scaleDegreeAlteration = "♭";
                        else if (scaleDegreeUnaltered == 7) scaleDegreeUnaltered = 6;
                        else if (scaleDegreeUnaltered == 8) { scaleDegreeAlteration = "♭"; scaleDegreeUnaltered = 7; }
                        else if (scaleDegreeUnaltered == 9) { scaleDegreeUnaltered = 7; }
                    if (parallelMusicalKey.Type == MusicalKeyOrChord.Types.MajorKey)
                        if (scaleDegreeUnaltered == 3) scaleDegreeAlteration = "♯";
                        else if (scaleDegreeUnaltered == 6) scaleDegreeAlteration = "♯";
                    let romanNumeral = scaleDegreeAlteration + RelatedMusicalHarmonies.romanNumerals[scaleDegreeUnaltered - 1];
                    if (chordRoot.AddInterval(MusicalInterval.MinorThird).IsEqual(musicalChord.NoteNames[1])) romanNumeral = romanNumeral.toLowerCase();
                    let annotation = new MusicalAnnotation(
                        musicalKey.Annotation.LeftBaseline + ": " + romanNumeral, musicalChord.Annotation.LeftSuperscript.replace("m", ""),
                        musicalChord.Annotation.MiddleSuperscript, musicalChord.Annotation.MiddleSubscript, "");
                    let ordinalNumber = (scaleDegreeAlteration == "♭" ? "lowered " : scaleDegreeAlteration == "♯" ? "raised " : "") + 
                        RelatedMusicalHarmonies.ordinalNumbers[scaleDegreeUnaltered - 1];
                    let nameInfix = musicalChord.Name.replace(musicalChord.TonicOrRoot.NamePrettified, "");
                    let name = musicalKey.Name + ":" + nameInfix + " on " + ordinalNumber + " scale degree";
                    let borrowedChord = new MusicalHarmony(type, name, annotation, musicalKey, musicalChord);
                    if (!borrowedChords.some(bc => bc.MusicalKey.IsEqual(musicalKey) && bc.MusicalChord.IsEqual(musicalChord))) borrowedChords.push(borrowedChord);
                }
            }
        }
        return borrowedChords;
    }

    static generateNeapolitanChords() {
        let neapolitanChords = new RelatedMusicalHarmonies();
        for (let musicalKey of RelatedMusicalHarmonies.allMusicalKeys) {
            let chordRoot = musicalKey.TonicOrRoot.AddInterval(MusicalInterval.MinorSecond);
            let filteredMusicalChords = RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.MajorTriadChord).filter(mtc => mtc.TonicOrRoot.IsEqual(chordRoot));
            if (filteredMusicalChords.length == 0) continue;
            let musicalChord = filteredMusicalChords[0];
            let musicalAnnotation = new MusicalAnnotation(musicalKey.Annotation.LeftBaseline + ": N", "", "", "", "");
            let name = musicalKey.Name + ": Neapolitan chord";
            let neapolitanChord = new MusicalHarmony(MusicalHarmony.Types.NeapolitanChord, name, musicalAnnotation, musicalKey, musicalChord);
            neapolitanChords.push(neapolitanChord);
        }
        return neapolitanChords;
    }

    static generateAugmentedSixthChords(type, tonicToRoot, musicalChords, harmonyAnnotationSuffix, harmonyNameSuffix) {
        let augmentedSixthChords = new RelatedMusicalHarmonies();
        for (let musicalKey of RelatedMusicalHarmonies.allMusicalKeys) {
            let chordRoot = musicalKey.TonicOrRoot.AddInterval(tonicToRoot);
            let filteredMusicalChords = musicalChords.filter(mc => mc.TonicOrRoot.IsEqual(chordRoot));
            if (filteredMusicalChords.length == 0) continue;
            let musicalChord = filteredMusicalChords[0];
            let musicalAnnotation = new MusicalAnnotation(musicalKey.Annotation.LeftBaseline + ": " + harmonyAnnotationSuffix, "+6", "", "", "");
            let name = musicalKey.Name + ": " + harmonyNameSuffix;
            let augmentedSixthChord = new MusicalHarmony(type, name, musicalAnnotation, musicalKey, musicalChord);
            augmentedSixthChords.push(augmentedSixthChord);
        }
        return augmentedSixthChords;
    }

    static generateSecondaryChords(musicalHarmonies) {
        let secondaryChords = new RelatedMusicalHarmonies();
        for (let musicalKey of RelatedMusicalHarmonies.allMusicalKeys) {
            let isMajorMusicalKey = musicalKey.Type == MusicalKeyOrChord.Types.MajorKey;
            for (let scaleDegree = 2; scaleDegree < 8; scaleDegree++) {
                if ((isMajorMusicalKey && scaleDegree == 7) || (!isMajorMusicalKey && scaleDegree == 2)) continue;
                let closelyRelatedKeyTonic = musicalKey.NoteNames[scaleDegree - 1];
                if (!isMajorMusicalKey && scaleDegree == 7) closelyRelatedKeyTonic = musicalKey.NoteNames[7];
                let closelyRelatedKeyType;
                if (isMajorMusicalKey) closelyRelatedKeyType = (scaleDegree == 4 || scaleDegree == 5) ? MusicalKeyOrChord.Types.MajorKey : MusicalKeyOrChord.Types.MinorKey;
                else closelyRelatedKeyType = (scaleDegree == 4 || scaleDegree == 5) ? MusicalKeyOrChord.Types.MinorKey : MusicalKeyOrChord.Types.MajorKey;
                let closelyRelatedKeys = RelatedMusicalHarmonies.allMusicalKeys.filter(
                    mk => mk.TonicOrRoot.IsEqual(closelyRelatedKeyTonic) && mk.Type == closelyRelatedKeyType);
                if (closelyRelatedKeys.length == 0) continue;
                let closelyRelatedKey = closelyRelatedKeys[0];
                let closelyRelatedKeyRomanNumeral = RelatedMusicalHarmonies.romanNumerals[scaleDegree - 1];
                if (closelyRelatedKeyType == MusicalKeyOrChord.Types.MinorKey) closelyRelatedKeyRomanNumeral = closelyRelatedKeyRomanNumeral.toLowerCase();
                let musicalHarmoniesInCloselyRelatedKey = musicalHarmonies.filter(
                    mh => mh.MusicalKey.IsEqual(closelyRelatedKey) && !mh.MusicalChord.TonicOrRoot.IsEqual(closelyRelatedKeyTonic));
                for (let musicalHarmony of musicalHarmoniesInCloselyRelatedKey) {
                    let name = musicalHarmony.Name.split(':')[1];
                    name = musicalKey.Name + ":" + name + " of closely related key on " + RelatedMusicalHarmonies.ordinalNumbers[scaleDegree - 1] + " scale degree ("
                        + closelyRelatedKey.Name + ")";
                    let leftBaseline = musicalHarmony.Annotation.LeftBaseline;
                    leftBaseline = leftBaseline.split(':')[1];
                    let musicalAnnotation = new MusicalAnnotation(musicalKey.Annotation.LeftBaseline + ":" + leftBaseline,
                        musicalHarmony.Annotation.LeftSuperscript, musicalHarmony.Annotation.MiddleSuperscript, musicalHarmony.Annotation.MiddleSubscript,
                        "/" + closelyRelatedKeyRomanNumeral);
                    let secondaryChord = new MusicalHarmony(RelatedMusicalHarmonies.secondaryChordsMappings.get(musicalHarmony.Type), name, musicalAnnotation, musicalKey, musicalHarmony.MusicalChord);
                    secondaryChords.push(secondaryChord);
                }
            }
        }
        return secondaryChords;
    }

    static generate() {
        RelatedMusicalHarmonies.cache = new Map();
        RelatedMusicalHarmonies.cache.set(MusicalHarmony.Types.DiatonicTriadChord,
            RelatedMusicalHarmonies.generateDiatonicChords(MusicalHarmony.Types.DiatonicTriadChord, RelatedMusicalHarmonies.allTriadChords));
        RelatedMusicalHarmonies.cache.set(MusicalHarmony.Types.DiatonicSeventhChord,
            RelatedMusicalHarmonies.generateDiatonicChords(MusicalHarmony.Types.DiatonicSeventhChord, RelatedMusicalHarmonies.allSeventhChords));
        RelatedMusicalHarmonies.cache.set(MusicalHarmony.Types.DiatonicNinthChord,
            RelatedMusicalHarmonies.generateDiatonicChords(MusicalHarmony.Types.DiatonicNinthChord, RelatedMusicalHarmonies.allNinthChords));
        RelatedMusicalHarmonies.cache.set(MusicalHarmony.Types.BorrowedTriadChord,
            RelatedMusicalHarmonies.generateBorrowedChords(MusicalHarmony.Types.BorrowedTriadChord, RelatedMusicalHarmonies.allTriadChords, "triad"));
        RelatedMusicalHarmonies.cache.set(MusicalHarmony.Types.BorrowedSeventhChord,
            RelatedMusicalHarmonies.generateBorrowedChords(MusicalHarmony.Types.BorrowedSeventhChord, RelatedMusicalHarmonies.allSeventhChords, "seventh"));
        RelatedMusicalHarmonies.cache.set(MusicalHarmony.Types.BorrowedNinthChord,
            RelatedMusicalHarmonies.generateBorrowedChords(MusicalHarmony.Types.BorrowedNinthChord, RelatedMusicalHarmonies.allNinthChords, "ninth"));
        RelatedMusicalHarmonies.cache.set(MusicalHarmony.Types.NeapolitanChord,
            RelatedMusicalHarmonies.generateNeapolitanChords());
        RelatedMusicalHarmonies.cache.set(MusicalHarmony.Types.ItalianSixthChord,
            RelatedMusicalHarmonies.generateAugmentedSixthChords(MusicalHarmony.Types.ItalianSixthChord, MusicalInterval.AugmentedFourth, RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.DiminishedTriadChordLowered3rd), "It", "Italian sixth chord"));
        RelatedMusicalHarmonies.cache.set(MusicalHarmony.Types.GermanSixthChord,
            RelatedMusicalHarmonies.generateAugmentedSixthChords(MusicalHarmony.Types.GermanSixthChord, MusicalInterval.AugmentedFourth, RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.DiminishedSeventhChordLowered3rd), "Gr", "German sixth chord"));
        RelatedMusicalHarmonies.cache.set(MusicalHarmony.Types.FrenchSixthChord,
            RelatedMusicalHarmonies.generateAugmentedSixthChords(MusicalHarmony.Types.FrenchSixthChord, MusicalInterval.MajorSecond, RelatedMusicalKeysOrChords.Get(MusicalKeyOrChord.Types.DominantSeventhChordLowered5th), "Fr", "French sixth chord"));
        RelatedMusicalHarmonies.cache.set(MusicalHarmony.Types.SecondaryDiatonicTriadChord,
            RelatedMusicalHarmonies.generateSecondaryChords(RelatedMusicalHarmonies.Get(MusicalHarmony.Types.DiatonicTriadChord)));
        RelatedMusicalHarmonies.cache.set(MusicalHarmony.Types.SecondaryDiatonicSeventhChord,
            RelatedMusicalHarmonies.generateSecondaryChords(RelatedMusicalHarmonies.Get(MusicalHarmony.Types.DiatonicSeventhChord)));
        RelatedMusicalHarmonies.cache.set(MusicalHarmony.Types.SecondaryDiatonicNinthChord,
            RelatedMusicalHarmonies.generateSecondaryChords(RelatedMusicalHarmonies.Get(MusicalHarmony.Types.DiatonicNinthChord)));
        RelatedMusicalHarmonies.cache.set(MusicalHarmony.Types.SecondaryNeapolitanChord,
            RelatedMusicalHarmonies.generateSecondaryChords(RelatedMusicalHarmonies.Get(MusicalHarmony.Types.NeapolitanChord)));
        RelatedMusicalHarmonies.cache.set(MusicalHarmony.Types.SecondaryItalianSixthChord,
            RelatedMusicalHarmonies.generateSecondaryChords(RelatedMusicalHarmonies.Get(MusicalHarmony.Types.ItalianSixthChord)));
        RelatedMusicalHarmonies.cache.set(MusicalHarmony.Types.SecondaryGermanSixthChord,
            RelatedMusicalHarmonies.generateSecondaryChords(RelatedMusicalHarmonies.Get(MusicalHarmony.Types.GermanSixthChord)));
        RelatedMusicalHarmonies.cache.set(MusicalHarmony.Types.SecondaryFrenchSixthChord,
            RelatedMusicalHarmonies.generateSecondaryChords(RelatedMusicalHarmonies.Get(MusicalHarmony.Types.FrenchSixthChord)));
    }

    constructor(...musicalHarmonies) {
        super(...musicalHarmonies);
    }
    
    Search(noteNames, musicalKey, fullMatchOnly, enharmonicEquivalence, bassNote) {
        if (noteNames.length == 0) return [];
        let musicalHarmonies = this;
        for (let searchedNoteName of noteNames) 
          if (!enharmonicEquivalence) musicalHarmonies = musicalHarmonies.filter(mh => mh.MusicalChord.NoteNames.some(nn => nn.Name == searchedNoteName.Name));
          else musicalHarmonies = musicalHarmonies.filter(mh => mh.MusicalChord.NoteNames.some(nn => nn.PitchClass == searchedNoteName.PitchClass));
        if (fullMatchOnly) musicalHarmonies = musicalHarmonies.filter(mh => mh.MusicalChord.NoteNames.length == noteNames.length);
        if (musicalKey != undefined) musicalHarmonies = musicalHarmonies.filter(mh => mh.MusicalKey.IsEqual(musicalKey));
        if (this[0].MusicalChord.HasInversions() && bassNote != undefined) musicalHarmonies = musicalHarmonies.map(mh => mh.GetInversion(bassNote));
        return musicalHarmonies;
    }

    ToString() {
        let string = "";
        let index = 0;
        for (let musicalHarmony of this) {
            if (index++ == 0) string += musicalHarmony.ToString();
            else string += ", " + musicalHarmony.ToString();
        }
        return string;
    }
}

class PianoKeys {

    constructor() {
        this.pianoKeysState = [-1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1];
        this.noteNamesForPianoKeys = [
            ["C", "B#", "Dbb"],
            ["C#", "Db", "Bx"],
            ["D", "Cx", "Ebb"],
            ["D#", "Eb", "Fbb"],
            ["E", "Dx", "Fb"],
            ["F", "E#", "Gbb"],
            ["F#", "Gb", "Ex"],
            ["G", "Fx", "Abb"],
            ["G#", "Ab"],
            ["A", "Gx", "Bbb"],
            ["A#", "Bb", "Cbb"],
            ["B", "Cb", "Ax"]];
    }

    IsAnyKeyPressed() {
        for (let pianoKeyState of this.pianoKeysState)
            if (pianoKeyState != -1) return true;
        return false;
    }

    IsPianoKeyPressed(pianoKeyIndex) {
        return this.pianoKeysState[pianoKeyIndex] != -1;
    }

    TogglePianoKey(pianoKeyIndex) {
        if (this.pianoKeysState[pianoKeyIndex] == this.noteNamesForPianoKeys[pianoKeyIndex].length - 1) {
            this.pianoKeysState[pianoKeyIndex] = -1;
            return;
        }
        this.pianoKeysState[pianoKeyIndex] += 1;
    }

    ReleasePianoKey(pianoKeyIndex) {
        this.pianoKeysState[pianoKeyIndex] = -1;
    }

    ReleaseAllPianoKeys() {
        for (let pianoKeyIndex = 0; pianoKeyIndex < 12; pianoKeyIndex++) this.pianoKeysState[pianoKeyIndex] = -1;
    }

    GetNoteNamesForAllPressedPianoKeys() {
        let noteNames = [];
        for (let pianoKeyIndex = 0; pianoKeyIndex < this.pianoKeysState.length; pianoKeyIndex++) {
            if (!this.IsPianoKeyPressed(pianoKeyIndex)) continue;
            let noteName = this.getNoteNameForPianoKey(pianoKeyIndex);
            noteNames.push(noteName);
        }
        return noteNames;
    }

    getNoteNameForPianoKey(pianoKeyIndex) {
        var pianoKeyState = this.pianoKeysState[pianoKeyIndex];
        return new NoteName(this.noteNamesForPianoKeys[pianoKeyIndex][pianoKeyState]);
    }
}

class FinderResults {

    constructor() {
        this.circleOfFifths =
            [new MusicalKeyOrChord(new NoteName("Cb"), MusicalKeyOrChord.Types.MajorKey), new MusicalKeyOrChord(new NoteName("Ab"), MusicalKeyOrChord.Types.MinorKey),
            new MusicalKeyOrChord(new NoteName("Gb"), MusicalKeyOrChord.Types.MajorKey), new MusicalKeyOrChord(new NoteName("Eb"), MusicalKeyOrChord.Types.MinorKey),
            new MusicalKeyOrChord(new NoteName("Db"), MusicalKeyOrChord.Types.MajorKey), new MusicalKeyOrChord(new NoteName("Bb"), MusicalKeyOrChord.Types.MinorKey),
            new MusicalKeyOrChord(new NoteName("Ab"), MusicalKeyOrChord.Types.MajorKey), new MusicalKeyOrChord(new NoteName("F"), MusicalKeyOrChord.Types.MinorKey),
            new MusicalKeyOrChord(new NoteName("Eb"), MusicalKeyOrChord.Types.MajorKey), new MusicalKeyOrChord(new NoteName("C"), MusicalKeyOrChord.Types.MinorKey),
            new MusicalKeyOrChord(new NoteName("Bb"), MusicalKeyOrChord.Types.MajorKey), new MusicalKeyOrChord(new NoteName("G"), MusicalKeyOrChord.Types.MinorKey),
            new MusicalKeyOrChord(new NoteName("F"), MusicalKeyOrChord.Types.MajorKey), new MusicalKeyOrChord(new NoteName("D"), MusicalKeyOrChord.Types.MinorKey),
            new MusicalKeyOrChord(new NoteName("C"), MusicalKeyOrChord.Types.MajorKey), new MusicalKeyOrChord(new NoteName("A"), MusicalKeyOrChord.Types.MinorKey),
            new MusicalKeyOrChord(new NoteName("G"), MusicalKeyOrChord.Types.MajorKey), new MusicalKeyOrChord(new NoteName("E"), MusicalKeyOrChord.Types.MinorKey),
            new MusicalKeyOrChord(new NoteName("D"), MusicalKeyOrChord.Types.MajorKey), new MusicalKeyOrChord(new NoteName("B"), MusicalKeyOrChord.Types.MinorKey),
            new MusicalKeyOrChord(new NoteName("A"), MusicalKeyOrChord.Types.MajorKey), new MusicalKeyOrChord(new NoteName("F#"), MusicalKeyOrChord.Types.MinorKey),
            new MusicalKeyOrChord(new NoteName("E"), MusicalKeyOrChord.Types.MajorKey), new MusicalKeyOrChord(new NoteName("C#"), MusicalKeyOrChord.Types.MinorKey),
            new MusicalKeyOrChord(new NoteName("B"), MusicalKeyOrChord.Types.MajorKey), new MusicalKeyOrChord(new NoteName("G#"), MusicalKeyOrChord.Types.MinorKey),
            new MusicalKeyOrChord(new NoteName("F#"), MusicalKeyOrChord.Types.MajorKey), new MusicalKeyOrChord(new NoteName("D#"), MusicalKeyOrChord.Types.MinorKey),
            new MusicalKeyOrChord(new NoteName("C#"), MusicalKeyOrChord.Types.MajorKey), new MusicalKeyOrChord(new NoteName("A#"), MusicalKeyOrChord.Types.MinorKey)];
    }

    Find(pianoKeys) {
        let noteNames = pianoKeys.GetNoteNamesForAllPressedPianoKeys();
        this.FoundMusicalKeysOrChords = new Map();
        for (let typeName in MusicalKeyOrChord.Types) {
            let type = MusicalKeyOrChord.Types[typeName];
            this.FoundMusicalKeysOrChords.set(type, RelatedMusicalKeysOrChords.Get(type).Search(noteNames, this.FullMatchesOnly, this.EnharmonicEquivalence, this.BassNote));
        }
        this.FoundMusicalHarmonies = new Map();
        for (let typeName in MusicalHarmony.Types) {
            let type = MusicalHarmony.Types[typeName];
            this.FoundMusicalHarmonies.set(type, RelatedMusicalHarmonies.Get(type).Search(noteNames, this.FilterByMusicalKey, this.FullMatchesOnly, this.EnharmonicEquivalence, this.BassNote));
        }
        let musicalKeys = [];
        for (let typeName in MusicalHarmony.Types) {
            let type = MusicalHarmony.Types[typeName];
            let musicalKeysForType = this.FoundMusicalHarmonies.get(type).map(mh => mh.MusicalKey);
            for (let musicalKey of musicalKeysForType)
                if (!musicalKeys.some(mk => mk.IsEqual(musicalKey))) musicalKeys.push(musicalKey);
        }
        musicalKeys.sort((mk1, mk2) => {
            let index1 = this.circleOfFifths.findIndex(mk => mk.IsEqual(mk1));
            let index2 = this.circleOfFifths.findIndex(mk => mk.IsEqual(mk2));
            return Math.sign(index1 - index2);
        });
        this.FoundMusicalKeysInHarmonies = musicalKeys;
    }
}

class FinderPage {

    constructor() {
        this.pianoKeys = new PianoKeys();
        this.results = new FinderResults();
    }

    renderPianoKeys() {
        for (var pianoKeyIndex = 0; pianoKeyIndex < this.pianoKeys.pianoKeysState.length; pianoKeyIndex++) {
            var isPianoKeyPressed = this.pianoKeys.IsPianoKeyPressed(pianoKeyIndex);
            var pianoKeyLabelElement = window.document.getElementById("label" + pianoKeyIndex);
            if (isPianoKeyPressed) pianoKeyLabelElement.innerText = this.pianoKeys.getNoteNameForPianoKey(pianoKeyIndex).NamePrettified;
            else pianoKeyLabelElement.innerText = "";
            var pianoKeyElement = window.document.getElementById(pianoKeyIndex);
            pianoKeyElement.style.backgroundColor = isPianoKeyPressed ? "deepskyblue" : "";
        }
    }

    renderFoundMusicalKeysOrChords() {
        for (let typeName in MusicalKeyOrChord.Types) {
            let type = MusicalKeyOrChord.Types[typeName];
            if (type == MusicalKeyOrChord.Types.DiminishedTriadChordLowered3rd || 
                type == MusicalKeyOrChord.Types.DiminishedSeventhChordLowered3rd || 
                type == MusicalKeyOrChord.Types.DominantSeventhChordLowered5th) continue;
            let results = this.results.FoundMusicalKeysOrChords.get(type);
            let html = "";
            let index = 0;
            for (let result of results) {
                if (html != "") html += ", ";
                html += "<span class='clickable' onclick='onMusicalKeyOrChordSelected(event, " + type + "," + index + ")' title='Click on result to show more details then click on details window to close it'>" + result.Annotation.Render() + "</span>";
                index++;
            }
            let element = document.getElementById("results" + type);
            element.innerHTML = html;
        }
    }

    renderFoundMusicalHarmonies() {
        for (let typeName in MusicalHarmony.Types) {
            let type = MusicalHarmony.Types[typeName];
            let results = this.results.FoundMusicalHarmonies.get(type);
            let html = "";
            let index = 0;
            for (let result of results) {
                if (html != "") html += ", ";
                html += "<span class='clickable' onclick='onMusicalHarmonySelected(event, " + type + "," + index + ")' title='Click on result to show more details then click on details window to close it'>" + result.Annotation.Render() + "</span>";
                index++;
            }
            let numberOfMusicalKeyOrChordTypes = Object.keys(MusicalKeyOrChord.Types).length;
            let element = document.getElementById("results" + (type + numberOfMusicalKeyOrChordTypes - 1));
            element.innerHTML = html
        }
    }

    renderResults() {
        this.renderFoundMusicalKeysOrChords();
        this.renderFoundMusicalHarmonies();
    }

    renderHarmonyView() {
        let noteNames = this.pianoKeys.GetNoteNamesForAllPressedPianoKeys();
        let indicatorLabels = { C: "", D: "", E: "", F: "", G: "", A: "", B: "" };
        for (let noteName of noteNames) indicatorLabels[noteName.Name.substring(0, 1)] += noteName.NamePrettified + " ";
        for (let name in indicatorLabels) {
            let indicatorElement = document.getElementById("indicator" + name);
            if (indicatorLabels[name] == "") {
                indicatorElement.style.backgroundColor = "";
                indicatorElement.innerHTML = name;
            }
            else {
                indicatorElement.style.backgroundColor = "deepSkyBlue";
                indicatorElement.innerHTML = indicatorLabels[name];
            }
        }
    }

    fillSelectionFilterByMusicalKey() {
        let selectionFilterByMusicalKey = document.getElementById("selectionFilterByMusicalKey");
        selectionFilterByMusicalKey.innerHTML = "<option value='none'>None</option>";
        for (let musicalKey of this.results.FoundMusicalKeysInHarmonies) {
            let accidentalCount = Math.floor((this.results.circleOfFifths.findIndex(mk => mk.IsEqual(musicalKey)) - 14) / 2);
            if (accidentalCount == 0) accidentalCount = "";
            if (accidentalCount < 0) accidentalCount = "(" + (-accidentalCount) + "♭" + ")";
            if (accidentalCount > 0) accidentalCount = "(" + accidentalCount + "♯" + ")";
            selectionFilterByMusicalKey.innerHTML += "<option value='" + musicalKey.ToString() + "'" +
                (musicalKey.IsEqual(this.results.FilterByMusicalKey) ? " selected" : "") + ">" +
                musicalKey.Name + accidentalCount + "</option>";
        }
    }

    fillSelectionBassNote() {
        let selectionBassNote = document.getElementById("selectionBassNote");
        selectionBassNote.innerHTML = "<option value='root'>Root position</option>";
        for (let noteName of this.pianoKeys.GetNoteNamesForAllPressedPianoKeys()) {
            selectionBassNote.innerHTML += "<option value='" + noteName.ToString() + "'" +
                (noteName.IsEqual(this.results.BassNote) ? " selected" : "") + ">" +
                "Bass note is " + noteName.NamePrettified + "</option>";
        }
    }

    selectRemembered()
    {
        if (this.results.RememberedKey != undefined) {
            let index = this.results.FoundMusicalKeysInHarmonies.findIndex(mk => mk.IsEqual(this.results.RememberedKey));
            if (index >= 0) {
                let element = document.getElementById("selectionFilterByMusicalKey");
                element.selectedIndex = index + 1;
                this.results.FilterByMusicalKey = this.results.RememberedKey;
                this.results.Find(this.pianoKeys);
                this.renderResults();                
                }
        }
    }

    OnPianoKeyPress(pianoKeyIndex, releaseKey) {
        if (!releaseKey) this.pianoKeys.TogglePianoKey(pianoKeyIndex);
        else this.pianoKeys.ReleasePianoKey(pianoKeyIndex);
        this.renderPianoKeys();
        this.renderHarmonyView();
        this.results.BassNote = undefined;
        this.results.FilterByMusicalKey = undefined;
        this.results.Find(this.pianoKeys);
        this.renderResults();
        this.fillSelectionBassNote();
        this.fillSelectionFilterByMusicalKey();
        this.selectRemembered();
    }

    OnReleaseAllPianoKeys() {
        this.pianoKeys.ReleaseAllPianoKeys();
        this.renderPianoKeys();
        this.renderHarmonyView();
        this.results.BassNote = undefined;
        this.results.FilterByMusicalKey = undefined;
        this.results.Find(this.pianoKeys);
        this.renderResults();
        this.fillSelectionBassNote();
        this.fillSelectionFilterByMusicalKey();
    }

    OnBassNoteSelected(newBassNote) {
        if (newBassNote != undefined)
            if (newBassNote.IsEqual(this.results.BassNote)) return;
        this.results.BassNote = newBassNote;
        this.results.Find(this.pianoKeys);
        this.renderResults();
    }

    OnEnharmonicEquivalenceChanged(enharmonicEquivalenceEnabled) {
        this.results.EnharmonicEquivalence = enharmonicEquivalenceEnabled;
        this.results.BassNote = undefined;
        this.results.FilterByMusicalKey = undefined;
        this.results.Find(this.pianoKeys);
        this.renderResults();
        this.fillSelectionBassNote();
        this.fillSelectionFilterByMusicalKey();
        this.selectRemembered();
    }

    OnFilterByMusicalKeySelected(newMusicalKey) {
        if (newMusicalKey != undefined)
            if (newMusicalKey.IsEqual(this.results.FilterByMusicalKey)) return;
        this.results.FilterByMusicalKey = newMusicalKey;
        this.results.Find(this.pianoKeys);
        this.renderResults();
    }

    OnRememberSelectionChanged(checked) {
        if (!checked) this.results.RememberedKey = undefined; 
        else this.results.RememberedKey = this.results.FilterByMusicalKey;
    }

    OnResultDescriptionHide() {
        document.getElementById('resultDescription').style.display = 'none';
    }

    OnRotateHarmonyView() {
        let indicatorCElement = document.getElementById("indicatorC");
        let indicatorDElement = document.getElementById("indicatorD");
        let indicatorEElement = document.getElementById("indicatorE");
        let indicatorFElement = document.getElementById("indicatorF");
        let indicatorGElement = document.getElementById("indicatorG");
        let indicatorAElement = document.getElementById("indicatorA");
        let indicatorBElement = document.getElementById("indicatorB");
        indicatorCElement.id = "indicatorE";
        indicatorEElement.id = "indicatorG";
        indicatorGElement.id = "indicatorB";
        indicatorBElement.id = "indicatorD";
        indicatorDElement.id = "indicatorF";
        indicatorFElement.id = "indicatorA";
        indicatorAElement.id = "indicatorC";
        this.renderHarmonyView();
    }

    SelectBassNote(noteName) {
        let selectionBassNote = document.getElementById("selectionBassNote");
        for (let o of selectionBassNote.options) {
            if (o.value == noteName) {
                selectionBassNote.selectedIndex = o.index;
                let newBassNote = new NoteName(noteName);
                finderPage.OnBassNoteSelected(newBassNote);
            }
        }    
    }
}

let finderPage = new FinderPage();

function onPianoKeyPress(event) {
    var pianoKeyIndex = event.currentTarget.id;
    var releaseKey = event.shiftKey;
    finderPage.OnPianoKeyPress(pianoKeyIndex, releaseKey);
    finderPage.OnResultDescriptionHide();
    event.stopPropagation();
}

function OnReleaseAllPianoKeys(event) {
    finderPage.OnReleaseAllPianoKeys();
    finderPage.OnResultDescriptionHide();
    event.stopPropagation();
}

function onBassNoteSelected(event) {
    let selectionBassNote = event.currentTarget;
    let selectedIndex = selectionBassNote.selectedIndex;
    let newBassNote;
    if (selectedIndex > 0) newBassNote = new NoteName(selectionBassNote.options[selectedIndex].value);
    finderPage.OnBassNoteSelected(newBassNote);
    finderPage.OnResultDescriptionHide();
    event.stopPropagation();
}

function onEnharmonicEquivalenceChanged(event) {
    let checkboxEnharmonicEquivalence = event.currentTarget;
    finderPage.OnEnharmonicEquivalenceChanged(checkboxEnharmonicEquivalence.checked);
    finderPage.OnResultDescriptionHide();
    event.stopPropagation();
}

function onFilterByMusicalKeySelected(event) {
    let selectionFilterByMusicalKey = event.currentTarget;
    let selectedIndex = selectionFilterByMusicalKey.selectedIndex;
    let newMusicalKey;
    if (selectedIndex > 0) {
        let selectedValue = selectionFilterByMusicalKey.options[selectedIndex].value;
        let tonic = new NoteName(selectedValue.substring(0, 1).toUpperCase() + selectedValue.substring(1));
        let isMajorKey = selectedValue.substring(0, 1) == selectedValue.substring(0, 1).toUpperCase();
        newMusicalKey = MusicalKeyOrChord.FromTonicOrRootAndType(tonic, isMajorKey ? MusicalKeyOrChord.Types.MajorKey : MusicalKeyOrChord.Types.MinorKey);
    }
    finderPage.OnFilterByMusicalKeySelected(newMusicalKey);
    finderPage.OnResultDescriptionHide();
    event.stopPropagation();
}

function onRememberSelectionChanged(event)
{
    let checkboxRememberSelection = event.currentTarget;
    if (checkboxRememberSelection.checked && selectionFilterByMusicalKey.selectedIndex==0) { 
        checkboxRememberSelection.checked = false; 
        event.stopPropagation();
        return; 
    }
    finderPage.OnRememberSelectionChanged(checkboxRememberSelection.checked);
    finderPage.OnResultDescriptionHide();
    event.stopPropagation();
}

function onTabSelected(event) {
    var tabElement = event.currentTarget;
    tabElement.className = "clickable tabSelected";
    var tabContentElement = document.getElementById(tabElement.id + "Content");
    tabContentElement.className = "";
    if (tabElement.id != "tab0") {
        document.getElementById("tab0").className = "clickable tabNotSelected";
        document.getElementById("tab0Content").className = "notDisplayed";
    }
    if (tabElement.id != "tab1") {
        document.getElementById("tab1").className = "clickable tabNotSelected";
        document.getElementById("tab1Content").className = "notDisplayed";
    }
    if (tabElement.id != "tab2") {
        document.getElementById("tab2").className = "clickable tabNotSelected";
        document.getElementById("tab2Content").className = "notDisplayed";
    }
    finderPage.OnResultDescriptionHide();
    event.stopPropagation();
}

function onMusicalKeyOrChordSelected(event, type, index) {
    let result = finderPage.results.FoundMusicalKeysOrChords.get(type)[index];
    let html = "<div class='annotation'><span>" + result.Annotation.Render() + "</span></div>"+ result.Name;
    let resultNameElement = document.getElementById("resultName");
    resultNameElement.innerHTML = html;
    html = "";
    let resultNoteNamesElement = document.getElementById("resultNoteNames");
    for (let noteName of result.NoteNames) html += (html != "" ? ", " : "") + noteName.NamePrettified
    resultNoteNamesElement.innerHTML = html;
    let resultDescriptionElement = document.getElementById("resultDescription");
    let width = window.innerWidth;
    if (event.clientX > width / 2) {
        resultDescriptionElement.style.right = width - event.clientX - 30;
        resultDescriptionElement.style.left = "";
    } else {
        resultDescriptionElement.style.left = event.clientX - 10;
        resultDescriptionElement.style.right = "";
    }
    let height = window.innerHeight;
    if (event.clientY > height / 2) {
        resultDescriptionElement.style.bottom = height - event.clientY - 10;
        resultDescriptionElement.style.top = "";
    } else {
        resultDescriptionElement.style.top = event.clientY - 10;
        resultDescriptionElement.style.bottom = "";
    }
    resultDescriptionElement.style.display = "block";
    event.stopPropagation();
}

function onMusicalHarmonySelected(event, type, index) {
    let result = finderPage.results.FoundMusicalHarmonies.get(type)[index];
    let html = "<div class='annotation'><span>" + result.Annotation.Render() + "</span></div>"+ result.Name + "<hr>";
    html += "<div class='annotation'><span>" + result.MusicalChord.Annotation.Render() + "</span></div>" + result.MusicalChord.Name;
    let resultNameElement = document.getElementById("resultName");
    resultNameElement.innerHTML = html;         
    html = "";
    for (let noteName of result.MusicalChord.NoteNames) html += (html != "" ? ", " : "") + noteName.NamePrettified
    let resultNoteNamesElement = document.getElementById("resultNoteNames");
    resultNoteNamesElement.innerHTML = html;
    let resultDescriptionElement = document.getElementById("resultDescription");
    let width = window.innerWidth;
    if (event.clientX > width / 2) {
        resultDescriptionElement.style.right = width - event.clientX - 30;
        resultDescriptionElement.style.left = "";
    }
    else {
        resultDescriptionElement.style.left = event.clientX - 10;
        resultDescriptionElement.style.right = "";
    }
    let height = window.innerHeight;
    if (event.clientY > height / 2) {
        resultDescriptionElement.style.bottom = height - event.clientY - 10;
        resultDescriptionElement.style.top = "";
    } else {
        resultDescriptionElement.style.top = event.clientY - 10;
        resultDescriptionElement.style.bottom = "";
    }
    resultDescriptionElement.style.display = "block";
    event.stopPropagation();
}

function onResultDescriptionHide(event) {
    finderPage.OnResultDescriptionHide();
    event.stopPropagation();
}

function onRotateHarmonyView(event) {
    finderPage.OnRotateHarmonyView();
    finderPage.OnResultDescriptionHide();
    event.stopPropagation();
}

function onLoad() {
    RelatedMusicalKeysOrChords.Get(0);
    RelatedMusicalHarmonies.Get(0);
    let waitAnimationElement = document.getElementById("waitAnimation");
    waitAnimationElement.style.display = "none";
}
    </script>
</head>

<body class="noSelect" onload="onLoad()" onclick="onResultDescriptionHide(event)">
    <img id="waitAnimation" style="position:absolute; left:40vw; top:40vh; width: 10em; height:10em" src="Gears.gif"></img>
    <div class="piano">
        <div class="pianoKeys" title="Click to press piano key. Click again to cycle through enharmonic equivalent note names and finally release key. Shift+click to immediately release piano key.">
            <div id="0" class="pianoKey whiteKey c clickable" onclick="onPianoKeyPress(event)"></div>
            <div id="1" class="pianoKey blackKey cSharp clickable" onclick="onPianoKeyPress(event)"></div>
            <div id="2" class="pianoKey whiteKey d clickable" onclick="onPianoKeyPress(event)"></div>
            <div id="3" class="pianoKey blackKey dSharp clickable" onclick="onPianoKeyPress(event)"></div>
            <div id="4" class="pianoKey whiteKey e clickable" onclick="onPianoKeyPress(event)"></div>
            <div id="5" class="pianoKey whiteKey f clickable" onclick="onPianoKeyPress(event)"></div>
            <div id="6" class="pianoKey blackKey fSharp clickable" onclick="onPianoKeyPress(event)"></div>
            <div id="7" class="pianoKey whiteKey g clickable" onclick="onPianoKeyPress(event)"></div>
            <div id="8" class="pianoKey blackKey gSharp clickable" onclick="onPianoKeyPress(event)"></div>
            <div id="9" class="pianoKey whiteKey a clickable" onclick="onPianoKeyPress(event)"></div>
            <div id="10" class="pianoKey blackKey aSharp clickable" onclick="onPianoKeyPress(event)"></div>
            <div id="11" class="pianoKey whiteKey b clickable" onclick="onPianoKeyPress(event)"></div>
        </div>
        <div class="pianoKeyLabels">
            <div id="label0" class="pianoKeyLabel whiteKeyLabel c"></div>
            <div id="label1" class="pianoKeyLabel blackKeyLabel cSharp"></div>
            <div id="label2" class="pianoKeyLabel whiteKeyLabel d"></div>
            <div id="label3" class="pianoKeyLabel blackKeyLabel dSharp"></div>
            <div id="label4" class="pianoKeyLabel whiteKeyLabel e"></div>
            <div id="label5" class="pianoKeyLabel whiteKeyLabel f"></div>
            <div id="label6" class="pianoKeyLabel blackKeyLabel fSharp"></div>
            <div id="label7" class="pianoKeyLabel whiteKeyLabel g"></div>
            <div id="label8" class="pianoKeyLabel blackKeyLabel gSharp"></div>
            <div id="label9" class="pianoKeyLabel whiteKeyLabel a"></div>
            <div id="label10" class="pianoKeyLabel blackKeyLabel aSharp"></div>
            <div id="label11" class="pianoKeyLabel whiteKeyLabel b"></div>
        </div>
    </div>
    <table class="harmonyView clickable" title="Click to rotate note names" onclick="onRotateHarmonyView(event)">
        <caption>v1.1</caption>
        <tr>
            <td id="indicatorA">A</td>
        </tr>
        <tr>
            <td id="indicatorF">F</td>
        </tr>
        <tr>
            <td id="indicatorD">D</td>
        </tr>
        <tr>
            <td id="indicatorB">B</td>
        </tr>
        <tr>
            <td id="indicatorG">G</td>
        </tr>
        <tr>
            <td id="indicatorE">E</td>
        </tr>
        <tr>
            <td id="indicatorC">C</td>
        </tr>
    </table>
    <div class="topMargin bottomMargin">      
        <span><input type="image" src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4IiBoZWlnaHQ9IjgiIHZpZXdCb3g9IjAgMCA4IDgiPgogIDxwYXRoIGQ9Ik00IDBsLTQgNWg4bC00LTV6bS00IDZ2Mmg4di0yaC04eiIgLz4KPC9zdmc+"
                class="clickable imageButton rightPading" title="Release all piano keys" alt="Release all piano keys"
                onClick="OnReleaseAllPianoKeys(event)"></span>
        Position:
        <select id="selectionBassNote" onchange="onBassNoteSelected(event)" class="clickable">
            <option value="root">Root position</option>
        </select>
        <span style="white-space:nowrap"><input type="checkbox" class="clickable" onchange="onEnharmonicEquivalenceChanged(event)">Enharmonic equivalence</span>
    </div>
    <div class="topMargin bottomMargin">
        <span id="tab0" class="clickable tabSelected" onclick="onTabSelected(event)">Keys</span>
        <span id="tab1" class="clickable tabNotSelected" onclick="onTabSelected(event)">Chords</span>
        <span id="tab2" class="clickable tabNotSelected" onclick="onTabSelected(event)">Harmonies</span>
    </div>
    <div id="tab0Content">
        <input type="checkbox" class="collapsibleSwitch clickable" checked />Major keys:</br>
        <div id="results0" class="collapsible annotation leftMargin"></div></br>
        <input type="checkbox" class="collapsibleSwitch clickable" checked />Minor keys:</br>
        <div id="results1" class="collapsible annotation leftMargin"></div></br>
        <div class="leftmargin" style="visibility:hidden">
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Minor keys without alterations:</br>
            <div id="results2" class="collapsible annotation leftMargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Minor keys with raised 7th scale degree:</br>
            <div id="results3" class="collapsible annotation leftMargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Minor keys with raised 6th and 7th scale degree:</br>
            <div id="results4" class="collapsible annotation leftMargin"></div>
        </div>
    </div>
    <div id="tab1Content" class="notDisplayed">
        <span class="heading">Triad chords</span></br>
        <div class="leftmargin">
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Major triad chords:</br>
            <div id="results5" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Minor triad chords:</br>
            <div id="results6" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Diminished triad chords:</br>
            <div id="results7" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Augmented triad chords:</br>
            <div id="results8" class="collapsible annotation leftmargin"></div></br>
        </div>
        <span class="heading">More common seventh chords</span></br>
        <div class="leftmargin">
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Dominant seventh chords:</br>
            <div id="results9" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Major seventh chords:</br>
            <div id="results10" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Minor seventh chords:</br>
            <div id="results11" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Diminished seventh chords:</br>
            <div id="results12" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Half-diminished seventh chords:</br>
            <div id="results13" class="collapsible annotation leftmargin"></div></br>
        </div>
        <span class="heading">Less common seventh chords</span></br>
        <div class="leftmargin">
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Augmented seventh chords:</br>
            <div id="results14" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Minor-major seventh chords:</br>
            <div id="results15" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Augmented-major seventh chords:</br>
            <div id="results16" class="collapsible annotation leftmargin"></div></br>
        </div>
        <span class="heading">Ninth chords</span></br>
        <div class="leftmargin">
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Dominant ninth chords:</br>
            <div id="results17" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Dominant minor ninth chords:</br>
            <div id="results18" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Major ninth chords:</br>
            <div id="results19" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Minor ninth chords:</br>
            <div id="results20" class="collapsible annotation leftmargin"></div></br>
        </div>
    </div>
    <div id="tab2Content" class="notDisplayed">
        <div class="topMargin bottomMargin">Filter by:
            <select id="selectionFilterByMusicalKey" onchange="onFilterByMusicalKeySelected(event)" class="clickable">
                <option value="none">None</option>
            </select>
            <span style="white-space:nowrap"><input type="checkbox" class="clickable" onchange="onRememberSelectionChanged(event)">Memorize</span>
        </div>
        <span class="heading">Diatonic chords</span></br>
        <div class="leftmargin">
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Diatonic triad chords:</br>
            <div id="results23" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Diatonic seventh chords:</br>
            <div id="results24" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Diatonic ninth chords:</br>
            <div id="results25" class="collapsible annotation leftmargin"></div></br>
        </div>
        </span>
        <span class="heading">Borrowed chords</span></br>
        <div class="leftmargin">
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Borrowed triad chords:</br>
            <div id="results26" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Borrowed seventh chords:</br>
            <div id="results27" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Borrowed ninth chords:</br>
            <div id="results28" class="collapsible annotation leftmargin"></div></br>
        </div>
        </span>
        <input type="checkbox" class="collapsibleSwitch clickable" checked />Neapolitan chords:</br>
        <div id="results29" class="collapsible annotation leftMargin"></div></br>
        <span class="heading">Augmented sixth chords</span></br>
        <div class="leftmargin">
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Italian sixth chords:</br>
            <div id="results30" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />German sixth chords:</br>
            <div id="results31" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />French sixth chords:</br>
            <div id="results32" class="collapsible annotation leftmargin"></div></br>
        </div>
        </span>
        <span class="heading">Secondary chords</span></br>
        <div class="leftmargin">
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Secondary diatonic triad chords:</br>
            <div id="results33" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Secondary diatonic seventh chords:</br>
            <div id="results34" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Secondary diatonic ninth chords:</br>
            <div id="results35" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Secondary Neapolitan chords:</br>
            <div id="results36" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Secondary Italian sixth chords:</br>
            <div id="results37" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Secondary German sixth chords:</br>
            <div id="results38" class="collapsible annotation leftmargin"></div></br>
            <input type="checkbox" class="collapsibleSwitch clickable" checked />Secondary French sixth chords:</br>
            <div id="results39" class="collapsible annotation leftmargin"></div></br>
        </div>
        </span>
    </div>
    <div id="resultDescription" class="smallWindow" >
        <span id="resultName"></span><hr>
        Contains note names: <span id="resultNoteNames"></span>
    </div>
</body>

</html>